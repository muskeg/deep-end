# Data Model: Underwater Cavern Exploration Game

**Date**: 2025-12-12  
**Purpose**: Entity definitions and relationships for game implementation

## Entity Definitions

### Player

**Purpose**: Represents the player-controlled diver character

**Properties**:
- `id`: String - Unique identifier
- `position`: {x: Number, y: Number} - Current position in pixels
- `velocity`: {x: Number, y: Number} - Movement vector
- `speed`: Number - Base movement speed (pixels/second)
- `oxygenLevel`: Number - Current oxygen percentage (0-100)
- `score`: Number - Accumulated points from pearl collection
- `isAlive`: Boolean - Game state flag
- `collisionRadius`: Number - Collision boundary size (pixels)
- `animationState`: String - Current animation ('idle', 'swim-up', 'swim-down', 'swim-left', 'swim-right', 'interact')

**Methods**:
- `move(direction)` - Update velocity based on input
- `collectPearl(pearl)` - Increase score, trigger collection effect
- `takeDamage(amount)` - Decrease oxygen from enemy collision
- `updateOxygen(deltaTime)` - Reduce oxygen based on elapsed time and environment
- `interact()` - Trigger clam opening when in range

**Relationships**:
- Collides with: Cavern walls, Enemies, Clams
- Interacts with: Clams (to collect Pearls)
- Affected by: WaterCurrents, OxygenSystem

**Validation Rules**:
- `oxygenLevel` must be 0-100
- `speed` must be positive
- `position` must be within cavern bounds
- `score` cannot be negative

---

### Cavern

**Purpose**: Procedurally generated level environment

**Properties**:
- `id`: String - Unique identifier
- `width`: Number - Grid width in tiles
- `height`: Number - Grid height in tiles
- `tileSize`: Number - Size of each tile in pixels
- `grid`: Array<Array<TileType>> - 2D array of tile types ('wall', 'water', 'current')
- `startPosition`: {x: Number, y: Number} - Player spawn location
- `difficulty`: Number - Level difficulty rating (1-10)
- `seed`: String - Random seed for reproducibility

**Methods**:
- `generate(seed, difficulty)` - Run Cellular Automata algorithm
- `validate()` - Ensure all areas are reachable
- `getTileAt(x, y)` - Get tile type at position
- `isWalkable(x, y)` - Check if position is passable
- `getConnectedRegions()` - Flood-fill to find isolated areas

**Relationships**:
- Contains: Clams, WaterCurrents, Enemies
- Bounds: Player movement
- Generated by: CavernGenerator system

**Validation Rules**:
- Must have exactly one connected region
- Must contain valid start position
- Minimum 40% open water area
- Wall border on all edges

**Generation Parameters** (vary by difficulty):
- Initial density: 45% (easy) → 55% (hard)
- Iterations: 4 (easy) → 7 (hard)
- Birth threshold: 5 neighbors
- Death threshold: 3 neighbors

---

### Clam

**Purpose**: Interactive collectible containing pearls

**Properties**:
- `id`: String - Unique identifier
- `position`: {x: Number, y: Number} - Fixed position in cavern
- `isOpen`: Boolean - Open/closed state
- `pearl`: Pearl - Contained pearl object
- `interactionRadius`: Number - Distance for player interaction (pixels)
- `animationState`: String - 'closed', 'opening', 'open'

**Methods**:
- `open()` - Trigger opening animation, reveal pearl
- `givePearl()` - Transfer pearl to player, mark as collected
- `canInteract(playerPosition)` - Check if player is in range

**Relationships**:
- Contains: One Pearl
- Interacted by: Player
- Placed in: Cavern (open water tiles only)

**Validation Rules**:
- Must be placed in open water (not walls or currents)
- Minimum spacing: 3 tiles between clams
- `interactionRadius` must be positive
- Cannot be opened twice

---

### Pearl

**Purpose**: Collectible item that increases player score

**Properties**:
- `id`: String - Unique identifier
- `value`: Number - Points awarded on collection
- `parentClam`: Clam - Reference to containing clam
- `isCollected`: Boolean - Collection state
- `visualEffect`: String - Sparkle/glow effect type

**Methods**:
- `collect()` - Mark as collected, trigger visual/audio feedback
- `getDisplayPosition()` - Calculate position relative to parent clam

**Relationships**:
- Contained by: Clam
- Collected by: Player

**Validation Rules**:
- `value` must be positive
- Cannot be collected twice
- Must have parent clam reference

**Value Calculation** (by difficulty):
- Base value: 10 points
- Difficulty multiplier: 1x (easy) → 2.5x (hard)
- Bonus for time remaining: +5% per 10 oxygen left

---

### Enemy (Base Class)

**Purpose**: Abstract base for hostile sea creatures

**Properties**:
- `id`: String - Unique identifier
- `type`: String - Enemy type ('jellyfish', 'eel', 'anglerfish')
- `position`: {x: Number, y: Number} - Current position
- `velocity`: {x: Number, y: Number} - Movement vector
- `speed`: Number - Movement speed (pixels/second)
- `health`: Number - Damage before defeat (future feature)
- `detectionRadius`: Number - Player detection range (pixels)
- `attackCooldown`: Number - Time between attacks (ms)
- `collisionRadius`: Number - Collision boundary size
- `animationState`: String - Current animation state

**Methods**:
- `update(deltaTime)` - Update position and behavior
- `detectPlayer(playerPosition)` - Check if player in range
- `attack(player)` - Apply damage to player
- `canAttack()` - Check if attack cooldown expired

**Relationships**:
- Patrols in: Cavern
- Attacks: Player
- Affected by: WaterCurrents (optional)

**Validation Rules**:
- `speed` must be positive
- `detectionRadius` >= `collisionRadius`
- `position` must be in open water

---

### Jellyfish (extends Enemy)

**Purpose**: Patrol-based enemy with predictable movement

**Additional Properties**:
- `patrolPath`: Array<{x, y}> - Waypoints for patrol route
- `currentWaypoint`: Number - Current patrol point index
- `patrolSpeed`: Number - Speed during patrol
- `chaseSpeed`: Number - Speed when chasing player

**Additional Methods**:
- `patrol()` - Move along patrol path
- `chase(playerPosition)` - Pursue player when detected
- `returnToPatrol()` - Resume patrol after losing player

**Behavior**:
- Follows predefined patrol path
- Detects player within radius
- Chases player at increased speed
- Returns to patrol if player escapes

---

### Eel (extends Enemy)

**Purpose**: Aggressive chase-based enemy

**Additional Properties**:
- `aggroRange`: Number - Distance to trigger chase
- `attackRange`: Number - Distance to perform attack
- `lungeSpeed`: Number - Speed during attack lunge

**Additional Methods**:
- `detect(playerPosition)` - Check if player in aggro range
- `pursue(playerPosition)` - Move toward player
- `lunge()` - Fast forward attack

**Behavior**:
- Hides in walls/corners until player approaches
- Emerges and pursues player aggressively
- Performs lunge attack when close
- Higher damage than jellyfish

---

### WaterCurrent

**Purpose**: Environmental hazard that pushes player

**Properties**:
- `id`: String - Unique identifier
- `position`: {x: Number, y: Number} - Current zone position
- `width`: Number - Zone width (pixels)
- `height`: Number - Zone height (pixels)
- `direction`: {x: Number, y: Number} - Normalized force vector
- `strength`: Number - Push force magnitude (0-1)
- `visualEffect`: String - Particle effect type

**Methods**:
- `applyForce(entity)` - Push entity in current direction
- `isInRange(position)` - Check if position affected
- `getVisualIntensity()` - Calculate particle density

**Relationships**:
- Placed in: Cavern (open water areas)
- Affects: Player, Enemies (optional)

**Validation Rules**:
- `direction` must be normalized vector
- `strength` must be 0-1
- Cannot overlap with walls or clams
- Minimum 2-tile spacing between currents

---

### Level

**Purpose**: Container for complete level configuration

**Properties**:
- `id`: String - Unique identifier
- `number`: Number - Sequential level number
- `difficulty`: Number - Difficulty rating (1-10)
- `cavern`: Cavern - Level environment
- `clams`: Array<Clam> - Collectibles in level
- `enemies`: Array<Enemy> - Hostile creatures
- `currents`: Array<WaterCurrent> - Environmental hazards
- `startingOxygen`: Number - Initial oxygen level (0-100)
- `oxygenDepletionRate`: Number - Oxygen loss per second
- `targetScore`: Number - Recommended score for level
- `completionTime`: Number - Player's completion time (tracked)

**Methods**:
- `initialize()` - Set up all entities and systems
- `isComplete()` - Check if all pearls collected
- `cleanup()` - Destroy entities for next level
- `getStatistics()` - Return completion stats

**Relationships**:
- Contains: Cavern, Clams, Enemies, WaterCurrents
- Tracks: Player progress and performance

**Validation Rules**:
- Must have ≥1 clam
- All clams must be reachable
- Enemy count scales with difficulty
- `startingOxygen` sufficient to complete level

**Difficulty Scaling**:
| Difficulty | Clams | Enemies | Currents | Starting O₂ | Depletion Rate |
|-----------|-------|---------|----------|-------------|----------------|
| 1 (Easy)  | 3-5   | 0-1     | 0-2      | 100%        | 1%/sec         |
| 3         | 5-8   | 2-3     | 2-4      | 90%         | 1.5%/sec       |
| 5         | 8-12  | 3-5     | 4-6      | 80%         | 2%/sec         |
| 7         | 10-15 | 5-8     | 6-8      | 70%         | 2.5%/sec       |
| 10 (Hard) | 15-20 | 8-12    | 8-12     | 60%         | 3%/sec         |

---

## Entity Relationships Diagram

```
Level
├── Cavern
│   ├── grid (2D array of tiles)
│   └── startPosition
├── Clams[] (3-20 depending on difficulty)
│   └── Pearl (1 per clam)
├── Enemies[] (0-12 depending on difficulty)
│   ├── Jellyfish (patrol behavior)
│   └── Eel (chase behavior)
└── WaterCurrents[] (0-12 depending on difficulty)

Player (singleton)
├── Interacts with → Clams
├── Collects from → Pearls
├── Collides with → Cavern walls, Enemies
└── Affected by → WaterCurrents, OxygenSystem

Systems (manage entities)
├── CavernGenerator → creates Cavern
├── CollisionSystem → detects Player ↔ Walls/Enemies/Clams
├── OxygenSystem → updates Player.oxygenLevel
├── CurrentSystem → applies WaterCurrent forces
└── DifficultySystem → configures Level parameters
```

---

## State Transitions

### Player States
- `alive` → `dead` (oxygen reaches 0 or enemy collision kills)
- `idle` → `moving` (keyboard input received)
- `moving` → `interacting` (spacebar near clam)
- `interacting` → `moving` (interaction complete)

### Clam States
- `closed` → `opening` (player interaction)
- `opening` → `open` (animation complete)
- `open` → `collected` (pearl taken)

### Enemy States
- `patrol` → `chase` (player detected)
- `chase` → `attack` (player in range)
- `attack` → `chase` (attack complete)
- `chase` → `patrol` (player escaped detection radius)

### Level States
- `loading` → `ready` (all entities initialized)
- `ready` → `playing` (player input received)
- `playing` → `complete` (all pearls collected)
- `playing` → `failed` (player oxygen reaches 0)

---

## Data Persistence

**LocalStorage Schema**:
```javascript
{
  "playerStats": {
    "highScore": Number,
    "levelsCompleted": Number,
    "totalPlayTime": Number,
    "fastestCompletion": Number
  },
  "settings": {
    "soundVolume": Number (0-1),
    "musicVolume": Number (0-1),
    "controlScheme": String ("arrows" | "wasd")
  },
  "unlockedLevels": Array<Number>
}
```

**No backend required** - all data stored locally in browser.

---

## Summary

**8 Core Entities Defined**:
- ✅ Player (player-controlled diver)
- ✅ Cavern (procedurally generated environment)
- ✅ Clam (interactive collectible)
- ✅ Pearl (score item)
- ✅ Enemy (base class for hostiles)
- ✅ Jellyfish (patrol enemy)
- ✅ Eel (chase enemy)
- ✅ WaterCurrent (environmental hazard)
- ✅ Level (configuration container)

**All entities have**:
- Clear properties and validation rules
- Defined methods and behaviors
- Explicit relationships
- State transition logic

**Ready for**: Contract generation and quickstart test scenarios (Phase 1 continued).
